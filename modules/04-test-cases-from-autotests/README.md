# Инструкция для Cursor: Создание/обновление тест-кейсов в TestRail на базе Playwright автотестов

## Быстрый старт (копипаст)

Пользователь добавляет в репозиторий файл(ы) с Playwright автотестами и даёт `SECTION_ID` в TestRail.

```
Открой и строго следуй инструкциям: modules/04-test-cases-from-autotests/README.md

Создай (или обнови) тест-кейсы в TestRail по Playwright автотестам.

Project ID (TestRail): 5
Section ID (TestRail): <SECTION_ID>
Файл(ы) с автотестами: <путь(и) в репозитории>
Режим: <create | update>
Refs (Jira): <DS-...>
Fix version (из Jira Fix versions): <например "M 2026.1.0">
Labels (подходящие по смыслу): <список названий или ID>
```

---

## 1) Правила (обязательно)

1) **Всегда сначала JSON, потом TestRail**

- Сначала формируешь и сохраняешь JSON в `results/04-test-cases-from-autotests/`
- Потом **останавливаешься**
- Только по команде пользователя применяешь изменения в TestRail

2) **Project**

- `project_id = 5`

3) **ID значений**

- Для `custom_fix_versions` и `labels` используй маппинг из файла `testrail-field-ids.md`
- Самостоятельно создавать/изменять лейблы/версии **запрещено**

---

## 2) Алгоритм работы

### Шаг 1 — Подготовка контекста

1) Используй `project_id = 5`.
2) Используй `SECTION_ID` от пользователя.
3) Прочитай предоставленный файл(ы) Playwright автотестов и составь список тестов, которые нужно обработать.

### Шаг 2 — Определить create/update для каждого теста

- Если в имени теста есть `[...]` с числовым id (например: `... [61960]`) — это `case_id` → **update** этого кейса.
- Если `case_id` в тесте нет:
  - режим `create` → **create**
  - режим `update` → попытаться найти подходящий кейс в секции по похожему `title`; если не найден — **create**

### Шаг 3 — Понять сценарий по автотесту

На основе кода автотеста восстанови:

- что именно проверяет автотест (user flow)
- какие предусловия нужны, чтобы сценарий был воспроизводимым
- что является наблюдаемым expected

### Шаг 4 — Сформировать данные кейса

- `title` — английский, кратко, по сути (бери из названия теста)
- `custom_preconds` — русский, простой многострочный текст (без списков/HTML)
- `custom_steps_separated` — шаги на русском:
  - 1 шаг предпочтительно, 2 шага максимум
  - в `expected` не ставь точки в конце строк
- `refs` — это задача на реализацию (`DS-...`)
- `custom_fix_versions` — 1 версия из Jira поля Fix versions → ID из `testrail-field-ids.md`
- `labels` — подбери по смыслу → ID из `testrail-field-ids.md`

### Шаг 5 — Сгенерировать и сохранить JSON-черновик (обязательно)

1) Сгенерируй **только JSON** для TestRail API (см. ниже).
2) Сохрани JSON в `results/04-test-cases-from-autotests/` с именем:
   - `dd_mm_yy_<label>.json`
3) **СТОП**: дождись команды пользователя на применение изменений в TestRail.

### Шаг 6 — Применение в TestRail (только по команде пользователя)

Выполняется только после команды пользователя, например:

- “Залей в TestRail”
- “Примени изменения в TestRail”

Действия:

1) Прочитай финальную версию JSON из `results/04-test-cases-from-autotests/`.
2) По JSON выполни операции в TestRail через MCP:
   - для `create` → `add_case`
   - для `update` → `update_case_fields`
3) В ответе пользователю выдай:
   - сколько кейсов создано/обновлено
   - список ID созданных/обновлённых кейсов (если доступно)

---

## 3) Формат вывода (JSON)

JSON содержит секции `create` и `update` (если применимо):

```json
{
  "create": {
    "section_id": 12345,
    "title": "Title",
    "type_id": 9,
    "priority_id": 2,
    "refs": "DS-1234",
    "custom_preconds": "строка\\nстрока",
    "custom_steps_separated": [
      { "content": "Шаг", "expected": "Ожидаемый результат" }
    ],
    "custom_fix_versions": [73],
    "labels": [56, 87]
  },
  "update": {
    "case_id": 353615,
    "fields": {
      "title": "Title",
      "type_id": 9,
      "priority_id": 2,
      "refs": "DS-1234",
      "custom_preconds": "строка\\nстрока",
      "custom_steps_separated": [
        { "content": "Шаг", "expected": "Ожидаемый результат" }
      ],
      "custom_fix_versions": [73],
      "labels": [56, 87]
    }
  }
}
```

