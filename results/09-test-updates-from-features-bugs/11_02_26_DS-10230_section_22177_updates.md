# Обновление тестов секции 22177 (Opening Typewell Trajectory tab) в связи с DS-10230

**Контекст:** [DS-10230](https://starsteer.atlassian.net/browse/DS-10230) — Typewells. SpreadSheet. Support new tab routing.  
**TestRail:** проект 5, секция 22177 «Opening Typewell Trajectory tab», 13 тест-кейсов.

---

## Что изменилось по DS-10230

- Формат хранения вкладки траектории: вместо отдельных полей используется **одна сущность** в `data.entity` с полем `type` (wellbore, wellPlan, typewell) и соответствующим uuid.
- Проверять **чтение и сохранение** формата в **drillspot-settings** (GET/POST `/projects/{uuid}/drillspot-monitoring-settings` или аналог).
- Требуется **обратная совместимость**: профили/дашборды, сохранённые в старом формате, должны открываться без ошибок.
- По задаче заведены и закрыты баги: DS-10692 (infinite loader при удалении Typewell), DS-10693 (infinite loader при переключении проектов с открытой вкладкой Typewell Trajectory).

---

## Формат drillspot-settings (актуальный)

Состояние вкладок траектории хранится в теле запроса **drillspot-settings** в массиве `tabs`. Каждая вкладка траектории описывается так:

```json
{
  "uuid": "...",
  "name": "Typewell Trajectory",
  "type": "Trajectory",
  "data": {
    "entity": {
      "type": "typewell",
      "typewellUuid": "caed830d-1439-4f05-88d5-43f06e4d8237"
    }
  }
}
```

Для Wellbore и WellPlan аналогично: `data.entity` с `type: "wellbore"` и `wellboreUuid` или `type: "wellPlan"` и `wellPlanUuid`. Поле `lastOpenedServiceWellbore` в текущем формате не используется — привязка к сущности идёт через `tabs[].data.entity`. В том же payload есть `tabLayout`, `activeTabUuid`, `lastOpenTab`, `openTabs` и прочие настройки приложения.

---

## 1. Обновление описания секции 22177

**Сейчас в описании секции указано:**

- URL: `/projects/{uuid}/trajectory/typewell_{typewell_uuid}`
- GET/POST drillspot-monitoring-settings: `lastOpenedServiceWellbore: "typewell_{typewell_uuid}"`

**Рекомендация:**

- Обновить описание под **текущий** формат (DS-10230):
  - Состояние вкладки Typewell Trajectory хранится в **drillspot-settings** в массиве `tabs`: элемент с `type: "Trajectory"` и `data.entity`: `{ "type": "typewell", "typewellUuid": "<uuid>" }`.
  - Упоминание `lastOpenedServiceWellbore` убрать или пометить как устаревшее; актуально — структура `tabs[].data.entity`.
- Добавить ссылку на DS-10230 и при необходимости кратко указать требование обратной совместимости (старые сохранённые профили должны открываться).

**Итог:** в описании секции 22177 зафиксировать актуальный формат (tabs + data.entity), убрать/уточнить устаревший lastOpenedServiceWellbore, добавить ссылку на DS-10230.

---

## 2. Какие тесты обновить и как

### 2.1 Явно завязаны на URL / адресную строку

| Case ID | Название | Что сделать |
|--------|----------|-------------|
| **285661** | Switching between Typewells in Typewell Trajectory tab | В ожидаемом результате есть: «При переключении изменяется UUID в адресной строке». Оставить проверку: URL обновляется при смене Typewell. При необходимости уточнить: в drillspot-settings в `tabs` вкладка траектории имеет `data.entity`: `{ "type": "typewell", "typewellUuid": "<актуальный_uuid>" }`. |

### 2.2 Сохранение/восстановление вкладки (drillspot-settings)

Сейчас в секции **нет** отдельного кейса на проверку сохранения/чтения вкладки Typewell Trajectory в drillspot-settings.

**Рекомендация:**

- **Либо** добавить новый тест в секцию 22177, например:
  - **Название:** «Typewell Trajectory tab state is saved and restored in drillspot-settings»
  - **Шаги:** открыть вкладку Typewell Trajectory для конкретного Typewell → перезагрузить страницу или перейти в другой проект и вернуться → убедиться, что вкладка восстановилась (тот же Typewell). Дополнительно: в теле запроса drillspot-settings в `tabs` есть элемент с `type: "Trajectory"` и `data.entity`: `{ "type": "typewell", "typewellUuid": "<uuid выбранного typewell>" }`.
- **Либо** добавить шаги в существующий кейс (например, в **285664** «Typewell Trajectory tab opens only one time»): после открытия вкладки проверить, что в drillspot-settings сохраняется вкладка в формате `tabs[].data.entity` (type + typewellUuid).

### 2.3 Обратная совместимость

**Рекомендация:** добавить один тест в секцию 22177:

- **Название (идея):** «Opening Typewell Trajectory tab with legacy profile (backward compatibility)»
  - **Предусловия:** пользователь с профилем/дашбордом, сохранённым в **старом** формате табов (например, без `data.entity` или с прежней структурой полей).
  - **Шаги:** открыть такой дашборд в текущей версии приложения.
  - **Ожидание:** вкладка Typewell Trajectory открывается без ошибок, данные отображаются корректно, нет бесконечной загрузки.

Так явно покроется требование из DS-10230 «не сломать старые дашборды».

### 2.4 Переключение проектов (связь с DS-10693)

| Case ID | Название | Что сделать |
|--------|----------|-------------|
| **285667** | Multiple Typewell Projects Filter | Второй шаг: «Открыть Typewell Trajectory для Typewell из одного проекта, затем переключиться на другой проект». В ожидаемый результат добавить явную проверку: **нет бесконечной загрузки** (infinite loader) при переключении проекта (исправлено в DS-10693). При необходимости добавить в refs задачи DS-10693 и DS-10230. |

### 2.5 Остальные кейсы секции

Кейсы ниже по смыслу не противоречат изменениям DS-10230; крупных правок не требуется.

- 285654 — No Typewells in a project  
- 285656 — New private dashboard with associated well. Monitoring zone  
- 285657 — Private dashboard with associated well. Analytics zone  
- 285658 — Private dashboard. Context menu  
- 285659 — Published dashboard. Context menu  
- 285660 — Typewell Ribbon Display and Content  
- 285662 — Ribbon switching from Typewell to Well  
- 285663 — Ribbon switching from Typewell to WellPlan  
- 285664 — Typewell Trajectory tab opens only one time  
- 285665 — Opened Typewell Trajectory tab isn't displayed in Open dashboards window  
- 285666 — Long Typewell Name Truncation in Ribbon  

---

## 3. Сводка действий

| Действие | Где |
|----------|-----|
| Обновить описание секции: формат `tabs[].data.entity` в drillspot-settings, убрать/уточнить lastOpenedServiceWellbore, ссылка DS-10230 | Секция 22177 |
| Уточнить ожидание по URL и при необходимости по drillspot-settings при переключении Typewell | Кейс 285661 |
| Добавить проверку «нет infinite loader» при смене проекта | Кейс 285667 |
| Добавить тест на сохранение/восстановление вкладки в drillspot-settings | Новый кейс или расширение 285664 |
| Добавить тест на открытие старых дашбордов (backward compatibility) | Новый кейс |

После внесения изменений в TestRail имеет смысл обновить или создать тест-ран для секции 22177 с обновлёнными кейсами.
